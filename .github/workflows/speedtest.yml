name: Daily Speedtest (London UK)

on:
  schedule:
    - cron: '0 0 * * *' # 每天 UTC 0点 (北京时间 8点) 运行
  workflow_dispatch: # 允许手动点击按钮触发

permissions:
  contents: write

jobs:
  speedtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download CloudflareSpeedTest
        run: |
          wget -N https://github.com/XIU2/CloudflareSpeedTest/releases/download/v2.2.5/CloudflareST_linux_amd64.tar.gz
          tar -zxf CloudflareST_linux_amd64.tar.gz
          chmod +x CloudflareST

      - name: Run SpeedTest (UK Filter)
        run: |
          # 1. 测速并锁定英国地区 (LHR, MAN, LGW)
          # 修改点：将输出文件名改为 ip.csv，这样生成的就是 CSV 文件
          ./CloudflareST -cfcolo LHR,MAN,LGW -dn 50 -o ip.csv -p 0

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 强制删除旧的 txt 文件（如果有），防止目录下同时存在 csv 和 txt
          rm -f ip.txt
          
          # 添加生成的 csv 文件
          git add ip.csv
          
          # 检查状态，如果有变化则提交
          if [[ -n $(git status -s) ]]; then
            # 这里的逻辑就是“覆盖”：它会把 ip.csv 的最新状态推送到仓库
            git commit -m "Update London IP list [$(date)]"
            
            # pull --rebase 是防止报错的关键，确保和远程仓库同步后再推送
            git pull --rebase origin main
            git push
          else
            echo "No changes to commit"
          fi
